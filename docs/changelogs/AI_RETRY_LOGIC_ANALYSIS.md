# AIè¡¥å…¨å’Œé‡è¯•é€»è¾‘åˆ†ææŠ¥å‘Š

ç”Ÿæˆæ—¶é—´: 2025-11-23
åˆ†æèŒƒå›´: gemini_enricher_v2.py, wos_standardizer_batch.py, enhanced_converter_batch_v2.py, rate_limiter.py

---

## ğŸ”´ ä¸¥é‡é—®é¢˜

### 1. **gemini_enricher_v2.py ç¼ºå°‘é€Ÿç‡é™åˆ¶** âš ï¸ CRITICAL

**ä½ç½®**: `gemini_enricher_v2.py:451-545` (`_call_gemini_api`)

**é—®é¢˜**:
```python
def _call_gemini_api(self, prompt: str) -> Optional[str]:
    """è°ƒç”¨Gemini APIï¼ˆ429é”™è¯¯æœ€å¤šé‡è¯•7æ¬¡ï¼Œå…¶ä»–é”™è¯¯æœ€å¤šé‡è¯•3æ¬¡ï¼‰"""

    # âŒ ç¼ºå°‘è¿™ä¸€è¡Œï¼
    # time.sleep(self.request_delay)  # <-- åº”è¯¥åœ¨è¿™é‡Œæ·»åŠ å»¶è¿Ÿ

    self.stats['api_calls'] += 1

    url = f"{self.config.api_url}/models/{self.config.model}:generateContent"
    # ...
```

**å¯¹æ¯”**: `wos_standardizer_batch.py:483-484` **æ­£ç¡®å®ç°**äº†é€Ÿç‡é™åˆ¶ï¼š
```python
def _call_gemini_api(self, prompt: str) -> Optional[str]:
    """è°ƒç”¨Gemini APIï¼ˆ429é”™è¯¯æœ€å¤šé‡è¯•7æ¬¡ï¼Œå…¶ä»–é”™è¯¯æœ€å¤šé‡è¯•3æ¬¡ï¼‰"""
    # âœ… é€Ÿç‡é™åˆ¶ï¼šåœ¨APIè°ƒç”¨å‰å»¶è¿Ÿï¼ˆé¿å…429é”™è¯¯ï¼‰
    time.sleep(self.request_delay)  # <-- æ­£ç¡®ï¼

    self.stats['api_calls'] += 1
    # ...
```

**å½±å“**:
- åœ¨æ‰¹é‡è¡¥å…¨æœºæ„ä¿¡æ¯æ—¶ï¼Œå¦‚æœ10ä¸ªæœºæ„åŒæ—¶è°ƒç”¨AIï¼Œä¼š**ç¬é—´å‘é€10ä¸ªè¯·æ±‚**
- å³ä½¿æœ‰æ‰¹æ¬¡é—´å»¶è¿Ÿï¼ˆ2ç§’ï¼‰ï¼Œä½†**æ‰¹æ¬¡å†…çš„è¯·æ±‚æ²¡æœ‰é—´éš”**
- è¿™æ˜¯å¯¼è‡´é¢‘ç¹429é”™è¯¯çš„ä¸»è¦åŸå› 

**ä¿®å¤å»ºè®®**:
```python
# gemini_enricher_v2.py:451
def _call_gemini_api(self, prompt: str) -> Optional[str]:
    """è°ƒç”¨Gemini APIï¼ˆ429é”™è¯¯æœ€å¤šé‡è¯•7æ¬¡ï¼Œå…¶ä»–é”™è¯¯æœ€å¤šé‡è¯•3æ¬¡ï¼‰"""

    # æ·»åŠ é€Ÿç‡é™åˆ¶ï¼ˆåœ¨APIè°ƒç”¨å‰å»¶è¿Ÿï¼‰
    time.sleep(1.5)  # æ¯æ¬¡APIè°ƒç”¨å‰ç­‰å¾…1.5ç§’

    self.stats['api_calls'] += 1
    # ... å…¶ä½™ä»£ç 
```

---

## ğŸŸ¡ ä¸­ç­‰é—®é¢˜

### 2. **rate_limiter.py æœªè¢«ä½¿ç”¨**

**ä½ç½®**: `rate_limiter.py`

**é—®é¢˜**:
- å®šä¹‰äº†å®Œæ•´çš„é€Ÿç‡é™åˆ¶å™¨ç±»ï¼ˆä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œçº¿ç¨‹å®‰å…¨ï¼‰
- ä½†**æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹å®é™…ä½¿ç”¨**
- `gemini_enricher_v2.py`å’Œ`wos_standardizer_batch.py`éƒ½æ²¡æœ‰å¯¼å…¥æˆ–è°ƒç”¨

**å»ºè®®**:
```python
# åœ¨ gemini_enricher_v2.py é¡¶éƒ¨æ·»åŠ 
from rate_limiter import get_global_rate_limiter

# åœ¨ _call_gemini_api ä¸­ä½¿ç”¨
def _call_gemini_api(self, prompt: str) -> Optional[str]:
    """è°ƒç”¨Gemini API"""

    # ä½¿ç”¨å…¨å±€é€Ÿç‡é™åˆ¶å™¨
    get_global_rate_limiter().acquire()

    self.stats['api_calls'] += 1
    # ...
```

---

### 3. **é‡è¯•é€»è¾‘æ··ä¹±ï¼ˆåŒå±‚é‡è¯•ï¼‰**

**ä½ç½®**: `gemini_enricher_v2.py`

**é—®é¢˜**:
- **å¤–å±‚é‡è¯•** (`_call_ai_with_retry`ï¼Œè¡Œ283-328): æœ€å¤š3æ¬¡ï¼Œå»¶è¿Ÿ5ç§’
- **å†…å±‚é‡è¯•** (`_call_gemini_api`ï¼Œè¡Œ451-545):
  - 429é”™è¯¯ï¼šæœ€å¤š7æ¬¡ï¼Œå»¶è¿Ÿ120ç§’
  - å…¶ä»–é”™è¯¯ï¼šæœ€å¤š3æ¬¡ï¼Œå»¶è¿Ÿ5ç§’

**é€»è¾‘æ··ä¹±**:
```python
# å¤–å±‚é‡è¯•
def _call_ai_with_retry(...):
    for attempt in range(1, self.config.max_retries + 1):  # 3æ¬¡
        try:
            response = self._call_gemini_api(prompt)  # è°ƒç”¨å†…å±‚
            # ...
        except Exception as e:
            if attempt < self.config.max_retries:
                time.sleep(self.config.retry_delay)  # 5ç§’

# å†…å±‚é‡è¯•ï¼ˆåœ¨ _call_gemini_api å†…éƒ¨ï¼‰
while True:
    # 429é”™è¯¯ï¼šæœ€å¤š7æ¬¡ï¼Œ120ç§’
    # å…¶ä»–é”™è¯¯ï¼šæœ€å¤š3æ¬¡ï¼Œ5ç§’
```

**é—®é¢˜**:
- å¦‚æœå†…å±‚å·²ç»é‡è¯•äº†7æ¬¡ï¼ˆ429ï¼‰ï¼Œå¤–å±‚è¿˜ä¼šå†é‡è¯•
- æœ€åæƒ…å†µï¼š7æ¬¡Ã—3æ¬¡ = 21æ¬¡é‡è¯•
- å»¶è¿Ÿæ—¶é—´ä¸ä¸€è‡´ï¼ˆ5ç§’ vs 120ç§’ï¼‰

**å»ºè®®**: ç§»é™¤å¤–å±‚é‡è¯•ï¼Œåªä¿ç•™å†…å±‚é‡è¯•é€»è¾‘

---

## âœ… æ­£ç¡®å®ç°

### 4. **wos_standardizer_batch.py** - æ­£ç¡®çš„é€Ÿç‡é™åˆ¶

**ä½ç½®**: `wos_standardizer_batch.py:483-484`

```python
def _call_gemini_api(self, prompt: str) -> Optional[str]:
    """è°ƒç”¨Gemini APIï¼ˆ429é”™è¯¯æœ€å¤šé‡è¯•7æ¬¡ï¼Œå…¶ä»–é”™è¯¯æœ€å¤šé‡è¯•3æ¬¡ï¼‰"""
    # âœ… é€Ÿç‡é™åˆ¶ï¼šåœ¨APIè°ƒç”¨å‰å»¶è¿Ÿï¼ˆé¿å…429é”™è¯¯ï¼‰
    time.sleep(self.request_delay)  # 1.5ç§’

    self.stats['api_calls'] += 1
    # ...
```

**ä¸ºä»€ä¹ˆæ­£ç¡®**:
- âœ… åœ¨APIè°ƒç”¨**ä¹‹å‰**å»¶è¿Ÿ
- âœ… ç¡®ä¿æ¯æ¬¡è¯·æ±‚é—´éš”è‡³å°‘1.5ç§’
- âœ… å³ä½¿å¹¶å‘è°ƒç”¨ï¼Œæ¯ä¸ªçº¿ç¨‹ä¹Ÿä¼šç­‰å¾…

---

### 5. **æ‰¹æ¬¡é—´å»¶è¿Ÿ** - å·²æ­£ç¡®å®ç°

**ä½ç½®**:
- `gemini_enricher_v2.py:238-241` - æ‰¹æ¬¡é—´å»¶è¿Ÿ2ç§’
- `wos_standardizer_batch.py:282-283, 306-308` - æ‰¹æ¬¡é—´å»¶è¿Ÿ2ç§’
- `enhanced_converter_batch_v2.py:142-144` - æ‰¹æ¬¡é—´å»¶è¿Ÿ3ç§’

```python
# æ‰¹æ¬¡é—´å»¶è¿Ÿï¼Œé¿å…429é”™è¯¯
if i + batch_size < len(to_enrich):
    logger.info(f"â¸ï¸  æ‰¹æ¬¡é—´å»¶è¿Ÿ2ç§’...")
    time.sleep(2.0)
```

**è¯„ä»·**: âœ… æ­£ç¡®ï¼Œä½†å¯ä»¥è€ƒè™‘å¢åŠ åˆ°3-5ç§’

---

## ğŸ“Š é‡è¯•æœºåˆ¶å¯¹æ¯”

| æ–‡ä»¶ | 429é”™è¯¯é‡è¯• | å…¶ä»–é”™è¯¯é‡è¯• | å»¶è¿Ÿä½ç½® | é€Ÿç‡é™åˆ¶ |
|------|------------|------------|----------|----------|
| gemini_enricher_v2.py | 7æ¬¡Ã—120ç§’ | 3æ¬¡Ã—5ç§’ | **âŒ æ— ** | **âŒ æ— ** |
| wos_standardizer_batch.py | 7æ¬¡Ã—120ç§’ | 3æ¬¡Ã—2ç§’ | **âœ… APIå‰** | **âœ… 1.5ç§’** |

**å»ºè®®**: gemini_enricher_v2.py åº”è¯¥éµå¾ª wos_standardizer_batch.py çš„å®ç°

---

## ğŸ”§ æ¨èçš„ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: å¿«é€Ÿä¿®å¤ï¼ˆæœ€å°æ”¹åŠ¨ï¼‰

åœ¨ `gemini_enricher_v2.py:451` æ·»åŠ ä¸€è¡Œï¼š

```python
def _call_gemini_api(self, prompt: str) -> Optional[str]:
    """è°ƒç”¨Gemini APIï¼ˆ429é”™è¯¯æœ€å¤šé‡è¯•7æ¬¡ï¼Œå…¶ä»–é”™è¯¯æœ€å¤šé‡è¯•3æ¬¡ï¼‰"""

    # æ·»åŠ è¿™ä¸€è¡Œ
    time.sleep(1.5)  # é€Ÿç‡é™åˆ¶ï¼šæ¯æ¬¡APIè°ƒç”¨å‰å»¶è¿Ÿ1.5ç§’

    self.stats['api_calls'] += 1
    url = f"{self.config.api_url}/models/{self.model}:generateContent"
    # ... å…¶ä½™ä»£ç ä¸å˜
```

**ä¼˜ç‚¹**: ç®€å•ï¼Œæ”¹åŠ¨æœ€å°
**ç¼ºç‚¹**: æ²¡æœ‰ä½¿ç”¨å·²æœ‰çš„rate_limiter.py

---

### æ–¹æ¡ˆ2: å®Œæ•´ä¿®å¤ï¼ˆæ¨èï¼‰

1. **ä½¿ç”¨å…¨å±€é€Ÿç‡é™åˆ¶å™¨**:
```python
# gemini_enricher_v2.py é¡¶éƒ¨æ·»åŠ 
from rate_limiter import get_global_rate_limiter

# åœ¨ _call_gemini_api ä¸­ä½¿ç”¨
def _call_gemini_api(self, prompt: str) -> Optional[str]:
    # ä½¿ç”¨å…¨å±€é€Ÿç‡é™åˆ¶å™¨ï¼ˆç¡®ä¿æ‰€æœ‰APIè°ƒç”¨ç»Ÿä¸€é€Ÿç‡ï¼‰
    get_global_rate_limiter().acquire()

    self.stats['api_calls'] += 1
    # ...
```

2. **ç§»é™¤å¤–å±‚é‡è¯•** (`_call_ai_with_retry`):
- ç›´æ¥åœ¨`enrich_institution`ä¸­è°ƒç”¨`_call_gemini_api`
- åªä¿ç•™å†…å±‚é‡è¯•é€»è¾‘

3. **å¢åŠ æ‰¹æ¬¡é—´å»¶è¿Ÿ**:
```python
# gemini_enricher_v2.py:238-241
if i + batch_size < len(to_enrich):
    logger.info(f"â¸ï¸  æ‰¹æ¬¡é—´å»¶è¿Ÿ5ç§’...")
    time.sleep(5.0)  # ä»2ç§’å¢åŠ åˆ°5ç§’
```

**ä¼˜ç‚¹**:
- ç»Ÿä¸€é€Ÿç‡é™åˆ¶
- ç®€åŒ–é‡è¯•é€»è¾‘
- å……åˆ†åˆ©ç”¨å·²æœ‰çš„rate_limiter.py

---

## ğŸ“ˆ æ€§èƒ½å½±å“é¢„ä¼°

### å½“å‰é…ç½®ï¼ˆæœ‰ç¼ºé™·ï¼‰:
- å¹¶å‘æ•°ï¼š5
- æ‰¹æ¬¡å¤§å°ï¼š10ï¼ˆæœºæ„è¡¥å…¨ï¼‰/ 20ï¼ˆæ ‡å‡†åŒ–ï¼‰
- é€Ÿç‡é™åˆ¶ï¼š**ç¼ºå¤±**ï¼ˆæœºæ„è¡¥å…¨ï¼‰/ 1.5ç§’ï¼ˆæ ‡å‡†åŒ–ï¼‰
- æ‰¹æ¬¡é—´å»¶è¿Ÿï¼š2-3ç§’

**é—®é¢˜**: æœºæ„è¡¥å…¨æ—¶ï¼Œ10ä¸ªè¯·æ±‚å¯èƒ½åŒæ—¶å‘é€ï¼Œå¯¼è‡´429é”™è¯¯

### ä¿®å¤åï¼ˆæ–¹æ¡ˆ1ï¼‰:
- å¹¶å‘æ•°ï¼š5
- æ‰¹æ¬¡å¤§å°ï¼š10 / 20
- é€Ÿç‡é™åˆ¶ï¼š1.5ç§’ï¼ˆæ‰€æœ‰APIè°ƒç”¨ï¼‰
- æ‰¹æ¬¡é—´å»¶è¿Ÿï¼š2-3ç§’

**é¢„æœŸæ”¹è¿›**:
- 429é”™è¯¯ï¼šé¢‘ç¹ â†’ æå°‘ï¼ˆ95%å‡å°‘ï¼‰
- å¤„ç†æ—¶é—´ï¼šç•¥å¾®å¢åŠ ï¼ˆ+10-20%ï¼‰
- ç¨³å®šæ€§ï¼šæ˜¾è‘—æå‡

### ä¿®å¤åï¼ˆæ–¹æ¡ˆ2ï¼‰:
- å…¨å±€é€Ÿç‡é™åˆ¶ï¼š1.5ç§’
- æ‰¹æ¬¡é—´å»¶è¿Ÿï¼š5ç§’
- é‡è¯•é€»è¾‘ï¼šç®€åŒ–

**é¢„æœŸæ”¹è¿›**:
- 429é”™è¯¯ï¼šå‡ ä¹æ¶ˆé™¤ï¼ˆ99%å‡å°‘ï¼‰
- å¤„ç†æ—¶é—´ï¼šå¢åŠ 20-30%
- ç¨³å®šæ€§ï¼šæœ€ä½³

---

## ğŸ¯ ç«‹å³è¡ŒåŠ¨å»ºè®®

1. **ç«‹å³ä¿®å¤ï¼ˆç´§æ€¥ï¼‰**:
   - åœ¨`gemini_enricher_v2.py:451`æ·»åŠ `time.sleep(1.5)`
   - æµ‹è¯•æ˜¯å¦è§£å†³429é”™è¯¯

2. **çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å¤©ï¼‰**:
   - ä½¿ç”¨`rate_limiter.py`ç»Ÿä¸€é€Ÿç‡é™åˆ¶
   - å¢åŠ æ‰¹æ¬¡é—´å»¶è¿Ÿåˆ°5ç§’

3. **é•¿æœŸä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰**:
   - é‡æ„é‡è¯•é€»è¾‘ï¼Œç§»é™¤åŒå±‚é‡è¯•
   - ç»Ÿä¸€æ‰€æœ‰æ–‡ä»¶çš„é‡è¯•ç­–ç•¥

---

## ğŸ“ æµ‹è¯•å»ºè®®

ä¿®å¤åæµ‹è¯•ï¼š
```bash
# æµ‹è¯•å°æ•°æ®é›†ï¼ˆ10æ¡è®°å½•ï¼‰
python3 institution_enricher_v2.py --input test_small.txt --output test_output.txt

# è§‚å¯Ÿæ—¥å¿—ï¼š
# - æ˜¯å¦æœ‰429é”™è¯¯
# - APIè°ƒç”¨é—´éš”æ˜¯å¦>1.5ç§’
# - é‡è¯•æ¬¡æ•°æ˜¯å¦åˆç†

# æµ‹è¯•å¤§æ•°æ®é›†ï¼ˆ100æ¡è®°å½•ï¼‰
python3 run_ai_workflow.py --data-dir "/path/to/data"
```

---

## æ€»ç»“

**å…³é”®å‘ç°**:
1. âŒ `gemini_enricher_v2.py`ç¼ºå°‘é€Ÿç‡é™åˆ¶ï¼ˆ**ä¸¥é‡ç¼ºé™·**ï¼‰
2. âŒ `rate_limiter.py`å®šä¹‰äº†ä½†æœªä½¿ç”¨
3. âš ï¸ åŒå±‚é‡è¯•é€»è¾‘æ··ä¹±
4. âœ… `wos_standardizer_batch.py`å®ç°æ­£ç¡®

**ä¼˜å…ˆçº§**:
1. **P0**: åœ¨`gemini_enricher_v2.py`æ·»åŠ é€Ÿç‡é™åˆ¶ï¼ˆ1è¡Œä»£ç ï¼‰
2. **P1**: ä½¿ç”¨`rate_limiter.py`ç»Ÿä¸€é€Ÿç‡æ§åˆ¶
3. **P2**: ç®€åŒ–é‡è¯•é€»è¾‘

**é¢„æœŸæ•ˆæœ**: 429é”™è¯¯ä»"é¢‘ç¹å‘ç”Ÿ"é™ä½åˆ°"å‡ ä¹æ¶ˆé™¤"
